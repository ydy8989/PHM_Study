# 7월 2주차

## Refer. Link

- https://mapr.com/blog/real-time-anomaly-detection-2/ : 무슨 h2o 아노말리?

- https://github.com/khundman/telemanom : 아래 사진 참고.
  ![1562637942938](https://github.com/ydy8989/PHM_Study/blob/master/pic/1562637942938.png)

- https://bcho.tistory.com/1198?category=555440 : auto encoder조대협





---

## Review 

> 지난주 계획
>
> - 전체 파일(혹은 그에 준하는 정도의 양)로 학습시키기
>
> - multi classification 시도
>
> - ~~Auto-Encoder 혹은 다른 Neural Network 시도~~  
>
> - Feature Engineering 방식 변경
>
>   - ex) Tumbling aggregates 방식을 통한 데이터 다운샘플링
>
>     ![Tumbling aggregates](https://docs.microsoft.com/en-us/azure/machine-learning/team-data-science-process/media/cortana-analytics-playbook-predictive-maintenance/tumbling-aggregate-features.png) 



## This Week

#### Check point

1. 데이터의 `time` column은 각 파일간 **별개의 column**이다.

   ex) File 05M01 >>  `Tool` : 05M01
         File 01M01 >>  `Tool` : 01M01

2. 

#### Experience

#### 1. 전체 파일 학습

> `Tool` 컬럼에 상관 없이, 전체 `Sensor_data` X_train과 `ttf_data` y_train을 이용하여 Sequencial하게 학습

##### 1.1. ISSUE

```
1. 파일별로 합친 뒤 한번에 정규화할 경우, 학습이 제대로 되지 않음
```

![](https://github.com/ydy8989/PHM_Study/blob/master/pic/6file_sum.png)

```
2. 파일별로 load한 후, 정규화한 뒤에 합칠 경우 time 컬럼 중복으로 인한 학습 불가능으로 이어짐.
```

> 개선해볼 여지가 있지만, time 컬럼을 제거한다면, 또 다른 세부적 전처리 과정 시 문제가 발생하여 이 방법은 포기하기로 하였음.



##### 1.2. insight

-  Loss 값이나 정확도는 비교적 안정적인 그래프(아래 그림)로 나왔지만(학습은 제대로 되고 있다는 뜻), 고장 시점을 비교적 정확히 예측하기 힘들다는 문제 발생

  ![](https://github.com/ydy8989/PHM_Study/blob/master/pic/50_epoch_loss_function.png)

  ![](https://github.com/ydy8989/PHM_Study/blob/master/pic/50_epoch_acc_graph.png)

- Sequential 하게 그래프 자체를 예측하려 시도하기보다는 구간별로 잘라서 Multi classification을 시도하기로 결정함 



#### 2. Multi Classification

![Multiclassification](https://github.com/ydy8989/PHM_Study/blob/master/pic/multiclassification.PNG)









## todo 



- ~~붙여서 테스트 해볼려고 시도해봄~~ >> 실패

- Feature engineering

  - 범주형 데이터와, 아닌것과 구분지을 필요 있음. 그래야 평균내는 의미가 있다...

  - ~~스테이지바뀔때 발생하는 빈시간 데이터 없애기.~~

    - ~~생각해보니 이럴 필요가 없음. 어차피 실제 테이블에는 없는 시간이라 텐서에 들어가지 않음.~~

  - ~~Tumbling aggregates : 구간 1개 당 한 번씩 평균내면서 전체 구간을 단위 구간만큼 나눈 사이즈로 축소하기~~ >> 완료

    ```python
    def Tumbling(sensor_data, divide_num):
        print('==================================================')
        print('Tumbling aggregates processing...................')
        print('==================================================')
        print(' ')
        #타임 컬럼 인덱스로
        sensor_data.index = pd.to_datetime(sensor_data.time, unit = 's')
        sensor_data = sensor_data.drop(['time'], axis = 1)
        
        #중복행 처리 : 인덱스 기준
        sensor_data = sensor_data.drop_duplicates()
    
        #범주형 데이터 컬럼 제거 
        no_cat_sensor = sensor_data.ix[:,4:]
        #인덱스는 divide_num의 첫번째 인덱스로 대표
        
        idx_lst = []
        a = []
        for idx, time in enumerate(no_cat_sensor.index):
            if idx % divide_num == 0:
                print('{}-th index / {} total, Tumbling aggregates processing...'.format(idx, len(no_cat_sensor)))
                idx_lst.append(time)
                a.append(no_cat_sensor[idx:idx+10].apply(lambda x:sum(x)/divide_num, axis = 0))
        tumble_df = pd.DataFrame(a, index = idx_lst)
        return tumble_df
    ```
    
  - 이동평균선 만들어서(예를들면 한시간 간격?) 튀어 나가는 범주를 계산하게끔 만들어 준다. !!!! 
  
    - 사실상 lstm 주가 예측 백테스팅 프로그램 부분이랑 굉장히 비슷할거같다...
  
  - 
  
- 전체 데이터 학습 모듈 만들기

  - ~~tumbling aggregates~~

- Auto-Encoder playing



## 확인 사항

1. 데이터의 `time` column은 각 파일간 **별개의 column**이다.

   ex) File 05M01 >>  `Tool` : 05M01
         File 01M01 >>  `Tool` : 01M01

2. 

   

## Insight

1. LSTM의 학습 방식에 대한 견해
   1. 전체 Sequence를 예측하기  
      - 장점 : 시계의 추이를 예측하기 쉽고, 시각화 했을 때, 
      - 단점 



## mind flow

- 리뷰

- 이번주

  - tumbling aggregate 시도 (다운 샘플링하기 300만 => 30만개)

  - lstm 모든 파일 합치기

    - 문제점 : 타임라인이 세부 Tool 이라는 column을 기준으로 나뉘어져 있었음. 즉 파일마다 시계열이 연결된 것이 아님

    - Sequence prediction 방식 : 

      - 전체 시퀀스 output을 1차원 형식으로 예측하기 위한 전처리 방식 : 

        ```
        파일로드
        cutoff
        series to supervised
        normalization
        lst에 append
        ```

        

    - Classification 방식 : 

      - 파일별 시계 정보를 무시하고, 학습시키기.

      - Multi Classification labeling

        ![multiclassification](C:\Users\hbee\PycharmProjects\PHM_Study\pic\multiclassification.PNG)

        - 이 경우의 문제점 ; label 0 값이 너무 많이 나옴

          ```
          하루안에 고장 : 레이블 2
          일주일 안에 고장 : 레이블 1
          일주일 안에 고장 안남 : 레이블 0 
          ```

          